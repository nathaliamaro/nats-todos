<div class="col-sm-4 todos" id="todo-list">
    <div class="paper">
        <div class="outer-box title" ><h1>Current to do</h1></div>

        <div class="panel panel-default" id="todo-template" style="display:none;"><!--START-SINGLE_TODO-->
            <div class="panel-body">
                <a href="#" class="glyphicon glyphicon-trash icon deleted"></a>
                <a id="title">Basic panel example</a>
                <div class="pull-right">
                    <input type="checkbox" class="completed"/> <!-- this! -->
                </div>
            </div>
        </div><!--END-SINGLE_TODO-->

        <div id="todo-container"></div>
    </div> <!-- end of .paper -->

</div><!-- END TODO LIST-->

<script>
    //|
    //| view controller
    //|
    //| Note the name below shall match id of the section
    //|
    window.app.page("todos", function() // registering the controller
    {
        // initialize view variables in localscope
        var $todolist = $(this).find('#todo-container');
        var $todotemplate = $(this).find('#todo-template');
        var $columnTitle = $(this).find(".outer-box.title");

        function completeOrNotTodo(todoId, completed){
            var ToDoObject = Parse.Object.extend("ToDoObject");
            var query = new Parse.Query(ToDoObject);

            query.get(todoId, {
              success: function(todo) {
                // The object was retrieved successfully, lets save the changes
                if(completed){
                  todo.set("completed", true);
                  todo.save(null, {
                    success: function(todo) {
                      // lets reload ourselves
                      $('section#todos').html('<div class="col-sm-4 text-center">Reloading todos...</div>');
                      window.refresh("todos");
                    }
                  });
                }else {
                  todo.set("completed", false);
                  todo.save(null, {
                    success: function(todo) {
                      // lets reload ourselves
                      $('section#todos').html('<div class="col-sm-4 text-center">Reloading todos...</div>');
                      window.refresh("todos");
                    }
                  });
                }
                
              },
              error: function(object, error) {
                alert('we failed!');
                // The object was not retrieved successfully.
                // error is a Parse.Error with an error code and message.
              }
            });
        }

        
        // presenter of the view - load data and show:
        return function() {
            var ToDoObject = Parse.Object.extend("ToDoObject");
            var query = new Parse.Query(ToDoObject);
            query.descending("createdAt");
            query.find({
              success: function(toDos) {
                // The object was retrieved successfully.
                var completedTodos = [];
                for (i = 0; i < toDos.length; i++){
                    $x = $($todotemplate).clone();
                    $x.css({display:'block'});
                    //if its completed we strikethrough
                    if(toDos[i].get("completed")){
                        $x.find("#title").css("text-decoration","line-through");
                    }
                    $x.find("#title").text(toDos[i].get("title")).attr('href', '#todo-details:'+toDos[i].id);
                    $x.click(function(){
                        $(".panel").removeClass("active-todo");
                        $(this).addClass("active-todo");

                    });
                    $x.find(".completed").attr("checked", toDos[i].get("completed")); 
                    $x.find(".completed").data("parse_id", toDos[i].id);                   
                    if (toDos[i].get("completed")) {
                        completedTodos.push($x);
                    } else { 
                        $todolist.append($x);
                    }

                    // attach an event handler for when they check or uncheck a todo
                    $x.find(".completed").change(function() {
                        if(this.checked) {
                            var parse_id = $(this).data("parse_id");
                            completeOrNotTodo(parse_id,true);
                        } else {
                            var parse_id = $(this).data("parse_id");
                            completeOrNotTodo(parse_id,false);
                        }
                    });

                    $x.find(".deleted").click(function() {
                        var parse_id = $(this).parent().find('.completed').data('parse_id');
                        var TodoObject = Parse.Object.extend("ToDoObject");
                        var query = new Parse.Query(TodoObject);
                        // console.log(todoId);
                        var deletedLink = this;
                        query.get(parse_id, {
                            success: function(todo){
                                todo.destroy({
                                    success: function(deletedTodo){
                                        $(deletedLink).parent().parent().slideUp();
                                        window.refresh("todo-details");

                                    }
                                });
                            }
                        });
                    });

                }

                for(i = 0; i< completedTodos.length; i++){
                    $todolist.append(completedTodos[i]);
                }
                //styles the todoList to start below the title
                $todolist.css({height:$(window).height()-$columnTitle.height()+'px'});

              },
              error: function(object, error) {
                // The object was not retrieved successfully.
                // error is a Parse.Error with an error code and message.
              }
            });
            $(window).resize(function(){
              $todolist.css({height:$(window).height()-$columnTitle.height()+'px'});
            });
        }
    });
</script>
